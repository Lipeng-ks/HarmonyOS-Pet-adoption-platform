<template>
  <div class="lost-pets-page">
    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="page-header">
      <h2>üîç ÂØªÂÆ†ÁÆ°ÁêÜ</h2>
      <p>ÁÆ°ÁêÜ‰∏¢Â§±ÂÆ†Áâ©‰ø°ÊÅØÂíåÂØªÊâæÁä∂ÊÄÅ</p>
    </div>

    <!-- Á≠õÈÄâÂô® -->
    <el-card class="filter-card" shadow="never">
      <div class="filter-container">
        <el-row :gutter="16" align="middle">
          <el-col :span="4">
            <el-select 
              v-model="filters.status" 
              clearable 
              placeholder="Áä∂ÊÄÅÁ≠õÈÄâ" 
              @change="fetchData"
            >
              <el-option value="ACTIVE" label="ÂØªÂÆ†‰∏≠" />
              <el-option value="FOUND" label="Â∑≤ÊâæÂà∞" />
              <el-option value="CLOSED" label="Â∑≤ÂÖ≥Èó≠" />
            </el-select>
          </el-col>
          
          <el-col :span="4">
            <el-input 
              v-model.number="filters.userId" 
              placeholder="Áî®Êà∑ID" 
              clearable 
              @change="fetchData" 
            />
          </el-col>
          
          <el-col :span="4">
            <el-select 
              v-model="filters.province" 
              clearable 
              placeholder="ÁúÅ‰ªΩÁ≠õÈÄâ" 
              @change="fetchData"
            >
              <el-option v-for="p in provinces" :key="p" :value="p" :label="p" />
            </el-select>
          </el-col>
          
          <el-col :span="8">
            <div class="stats-info">
              ÂÖ± {{ pagination.total }} Êù°ËÆ∞ÂΩï
            </div>
          </el-col>
          
          <el-col :span="4">
            <el-button type="primary" @click="openCreate">
              Êñ∞Â¢ûÂØªÂÆ†
            </el-button>
          </el-col>
        </el-row>
      </div>
    </el-card>

    <!-- ÂØªÂÆ†ÂàóË°® -->
    <el-card class="table-card" shadow="never">
      <el-table 
        :data="list" 
        v-loading="loading"
        empty-text="ÊöÇÊó†ÂØªÂÆ†‰ø°ÊÅØ"
        class="simple-table"
      >
        <el-table-column label="ÂÆ†Áâ©" width="100">
          <template #default="{ row }">
            <div class="pet-info">
              <el-avatar :src="renderImage(row.image)" :size="40">
                {{ row.petName?.charAt(0) || 'ÂÆ†' }}
              </el-avatar>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column label="Âü∫Êú¨‰ø°ÊÅØ" min-width="200">
          <template #default="{ row }">
            <div class="pet-details">
              <div class="pet-name">{{ row.petName || 'Êú™ÂëΩÂêç' }}</div>
              <div class="pet-type">{{ row.type }} ¬∑ {{ row.age }}Â≤Å</div>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column label="Âú∞Âå∫" width="150">
          <template #default="{ row }">
            <div class="location">
              <div>{{ cityProvinceMap[row.city] || '' }}</div>
              <div class="city">{{ row.city }}</div>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column label="ÊÇ¨Ëµè" width="100" align="center">
          <template #default="{ row }">
            <div v-if="row.reward && row.reward > 0" class="reward">
              ¬•{{ row.reward }}
            </div>
            <div v-else class="no-reward">-</div>
          </template>
        </el-table-column>
        
        <el-table-column prop="lostTime" label="Ëµ∞Â§±Êó∂Èó¥" width="120">
          <template #default="{ row }">
            <div class="lost-time">{{ formatDate(row.lostTime) }}</div>
          </template>
        </el-table-column>
        
        <el-table-column label="Áä∂ÊÄÅ" width="120">
          <template #default="{ row }">
            <el-tag 
              :type="row.status === 'ACTIVE' ? 'warning' : row.status === 'FOUND' ? 'success' : 'info'"
              size="small"
            >
              {{ statusLabel(row.status) }}
            </el-tag>
          </template>
        </el-table-column>
        
        <el-table-column label="Êìç‰Ωú" width="180" fixed="right">
          <template #default="{ row }">
            <el-button size="small" @click="openEdit(row)">
              ÁºñËæë
            </el-button>
            <el-dropdown 
              trigger="click" 
              @command="(s: 'ACTIVE' | 'FOUND' | 'CLOSED') => changeStatus(row, s)"
            >
              <el-button size="small" type="primary">
                Áä∂ÊÄÅ
              </el-button>
              <template #dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item command="ACTIVE">ÂØªÂÆ†‰∏≠</el-dropdown-item>
                  <el-dropdown-item command="FOUND">Â∑≤ÊâæÂà∞</el-dropdown-item>
                  <el-dropdown-item command="CLOSED">Â∑≤ÂÖ≥Èó≠</el-dropdown-item>
                </el-dropdown-menu>
              </template>
            </el-dropdown>
            <el-popconfirm title="Á°ÆËÆ§Âà†Èô§Ôºü" @confirm="onDelete(row)">
              <template #reference>
                <el-button size="small" type="danger">Âà†Èô§</el-button>
              </template>
            </el-popconfirm>
          </template>
        </el-table-column>
      </el-table>

      <el-empty 
        v-if="!loading && list.length === 0" 
        description="ÊöÇÊó†ÂØªÂÆ†‰ø°ÊÅØ"
        :image-size="120"
      />
      
      <!-- ÂàÜÈ°µ -->
      <div class="pagination-wrapper" v-if="list.length > 0">
        <el-pagination
          v-model:current-page="pagination.currentPage"
          v-model:page-size="pagination.pageSize"
          :page-sizes="[10, 20, 50, 100]"
          :total="pagination.total"
          layout="total, sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
        />
      </div>
    </el-card>

    <!-- ÁºñËæëÂØπËØùÊ°Ü -->
    <el-dialog 
      v-model="dialog.visible" 
      :title="dialog.isEdit ? 'ÁºñËæëÂØªÂÆ†' : 'Êñ∞Â¢ûÂØªÂÆ†'" 
      width="600px"
      :close-on-click-modal="false"
    >
      <el-form :model="dialog.form" label-width="100px" class="dialog-form">
        <el-form-item label="Ê†áÈ¢ò">
          <el-input v-model="dialog.form.title" placeholder="ËØ∑ËæìÂÖ•ÂØªÂÆ†Ê†áÈ¢ò" />
        </el-form-item>
        
        <el-form-item label="ÂÆ†Áâ©Âêç">
          <el-input v-model="dialog.form.petName" placeholder="ËØ∑ËæìÂÖ•ÂÆ†Áâ©ÂêçÂ≠ó" />
        </el-form-item>
        
        <el-form-item label="Á±ªÂûã">
          <el-select v-model="dialog.form.type" placeholder="ÈÄâÊã©ÂÆ†Áâ©Á±ªÂûã" style="width: 100%">
            <el-option value="dog" label="ÁãóÁãó" />
            <el-option value="cat" label="Áå´Âí™" />
            <el-option value="other" label="ÂÖ∂‰ªñ" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="ÁúÅÂ∏Ç">
          <el-row :gutter="8">
            <el-col :span="10">
              <el-select 
                v-model="dialogProvince" 
                placeholder="ÁúÅ‰ªΩ" 
                @change="onDialogProvinceChange"
              >
                <el-option v-for="p in provinces" :key="p" :value="p" :label="p" />
              </el-select>
            </el-col>
            <el-col :span="14">
              <el-select v-model="dialog.form.city" placeholder="ÂüéÂ∏Ç">
                <el-option v-for="c in cities" :key="c" :value="c" :label="c" />
              </el-select>
            </el-col>
          </el-row>
        </el-form-item>
        
        <el-form-item label="Âπ¥ÈæÑ">
          <el-input-number 
            v-model="dialog.form.age" 
            :min="0" 
            :max="50" 
            placeholder="ÂÆ†Áâ©Âπ¥ÈæÑ"
          />
        </el-form-item>
        
        <el-form-item label="ÂõæÁâá">
          <div class="image-upload">
            <el-upload
              :http-request="onFileUpload"
              :show-file-list="false"
              accept="image/*"
            >
              <el-button>‰∏ä‰º†ÂõæÁâá</el-button>
            </el-upload>
            <el-input 
              v-model="dialog.form.image" 
              placeholder="ÊàñËæìÂÖ•ÂõæÁâáÈìæÊé•" 
              style="margin-left: 8px; flex: 1"
            />
          </div>
          <div v-if="dialog.form.image" class="image-preview">
            <el-image 
              :src="renderImage(dialog.form.image) || ''" 
              style="width: 100px; height: 100px" 
              fit="cover" 
            />
          </div>
        </el-form-item>
        
        <el-form-item label="Ëµ∞Â§±Êó∂Èó¥">
          <el-date-picker 
            v-model="dialog.form.lostTime" 
            type="datetime" 
            value-format="YYYY-MM-DDTHH:mm:ss" 
            placeholder="ÈÄâÊã©Ëµ∞Â§±Êó∂Èó¥" 
            style="width: 100%"
          />
        </el-form-item>
        
        <el-form-item label="Ëµ∞Â§±Âú∞ÂùÄ">
          <el-input v-model="dialog.form.lostAddress" placeholder="ËØ¶ÁªÜËµ∞Â§±Âú∞ÂùÄ" />
        </el-form-item>
        
        <el-form-item label="ËÅîÁ≥ª‰∫∫">
          <el-input v-model="dialog.form.contactName" placeholder="ËÅîÁ≥ª‰∫∫ÂßìÂêç" />
        </el-form-item>
        
        <el-form-item label="ËÅîÁ≥ªÁîµËØù">
          <el-input v-model="dialog.form.contactPhone" placeholder="ËÅîÁ≥ªÁîµËØù" />
        </el-form-item>
        
        <el-form-item label="ÊÇ¨ËµèÈáëÈ¢ù">
          <el-input-number 
            v-model="dialog.form.reward" 
            :min="0" 
            :max="999999" 
            :precision="2"
            :step="100"
            placeholder="ÊÇ¨ËµèÈáëÈ¢ù"
            style="width: 200px"
          />
          <span style="margin-left: 8px; color: #909399;">ÂÖÉ</span>
        </el-form-item>
        
        <el-form-item label="ÊèèËø∞">
          <el-input 
            v-model="dialog.form.description" 
            type="textarea" 
            :rows="3" 
            placeholder="ËØ¶ÁªÜÊèèËø∞ÂÆ†Áâ©ÁâπÂæÅ"
          />
        </el-form-item>
        
        <el-form-item label="Áä∂ÊÄÅ">
          <el-select v-model="dialog.form.status" style="width: 160px">
            <el-option value="ACTIVE" label="ÂØªÂÆ†‰∏≠" />
            <el-option value="FOUND" label="Â∑≤ÊâæÂà∞" />
            <el-option value="CLOSED" label="Â∑≤ÂÖ≥Èó≠" />
          </el-select>
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="dialog.visible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" :loading="submitting" @click="onSubmit">
          ‰øùÂ≠ò
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { 
  listLostPets, 
  listLostPetsByUser, 
  createLostPet, 
  updateLostPet, 
  deleteLostPet, 
  updateStatus, 
  type LostPet 
} from '@/services/lostpets'
import { uploadFile } from '@/services/upload'
import { listProvinces, listCitiesByProvince } from '@/services/provinces'

const loading = ref(false)
const list = ref<LostPet[]>([])
const filters = reactive<{ 
  status?: 'ACTIVE' | 'FOUND' | 'CLOSED' | null
  userId?: number | null
  province?: string | null 
}>({ 
  status: null, 
  userId: null, 
  province: null 
})

// ÂàÜÈ°µÊï∞ÊçÆ
const pagination = reactive({
  currentPage: 1,
  pageSize: 20,
  total: 0
})

const dialog = reactive<{ visible: boolean; isEdit: boolean; form: LostPet }>({
  visible: false,
  isEdit: false,
  form: { 
    title: '', 
    petName: '', 
    type: '', 
    city: '', 
    age: 0, 
    image: '', 
    lostTime: '', 
    lostAddress: '', 
    contactName: '', 
    contactPhone: '', 
    status: 'ACTIVE' 
  }
})
const submitting = ref(false)

// ÁúÅÂ∏ÇËÅîÂä®
const provinces = ref<string[]>([])
const cities = ref<string[]>([])
const dialogProvince = ref<string>('')

// ÁúÅÂ∏ÇÊò†Â∞ÑÁºìÂ≠ò
const provinceCityMap = ref<Record<string, string[]>>({})
const cityProvinceMap = ref<Record<string, string>>({})

function renderImage(val?: string | null) {
  if (!val) return ''
  if (val.startsWith('app.media.')) return ''
  return val
}

async function fetchData() {
  loading.value = true
  try {
    const params: any = {}
    if (filters.status) params.status = filters.status
    let res
    if (filters.userId) {
      res = await listLostPetsByUser(filters.userId)
    } else {
      res = await listLostPets(params)
    }
    let data = res.data || []
    
    // Â¶ÇÊûúÊúâÁúÅ‰ªΩÁ≠õÈÄâÔºåËøõË°åÂâçÁ´ØËøáÊª§
    if (filters.province) {
      data = data.filter((item: LostPet) => item.city && cityProvinceMap.value[item.city] === filters.province)
    }
    
    // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
    pagination.total = data.length
    
    // ÂàÜÈ°µÂ§ÑÁêÜ
    const startIndex = (pagination.currentPage - 1) * pagination.pageSize
    const endIndex = startIndex + pagination.pageSize
    list.value = data.slice(startIndex, endIndex)
  } catch (e: any) {
    ElMessage.error(e.message || 'Âä†ËΩΩÂ§±Ë¥•')
  } finally {
    loading.value = false
  }
}

function openCreate() {
  dialog.isEdit = false
  dialog.form = { 
    title: '', 
    petName: '', 
    type: '', 
    city: '', 
    age: 0, 
    image: '', 
    lostTime: '', 
    lostAddress: '', 
    contactName: '', 
    contactPhone: '', 
    status: 'ACTIVE' 
  }
  dialog.visible = true
  dialogProvince.value = ''
  cities.value = []
}

function openEdit(row: LostPet) {
  dialog.isEdit = true
  dialog.form = { ...row }
  dialog.visible = true
  if (dialog.form.city) {
    inferProvinceByCity(dialog.form.city)
  }
}

async function onSubmit() {
  submitting.value = true
  try {
    if (dialog.isEdit && dialog.form.id) {
      const res = await updateLostPet(dialog.form.id, dialog.form)
      if (res.success) ElMessage.success('Êõ¥Êñ∞ÊàêÂäü')
    } else {
      const res = await createLostPet(dialog.form)
      if (res.success) ElMessage.success('ÂàõÂª∫ÊàêÂäü')
    }
    dialog.visible = false
    fetchData()
  } catch (e: any) {
    ElMessage.error(e.message || 'Êìç‰ΩúÂ§±Ë¥•')
  } finally {
    submitting.value = false
  }
}

async function onDelete(row: LostPet) {
  try {
    const res = await deleteLostPet(row.id!)
    if (res.success) {
      ElMessage.success('Âà†Èô§ÊàêÂäü')
      fetchData()
    }
  } catch (e: any) {
    ElMessage.error(e.message || 'Âà†Èô§Â§±Ë¥•')
  }
}

async function onFileUpload(opts: any) {
  try {
    const res = await uploadFile(opts.file as File)
    if (res.success && res.data?.url) {
      dialog.form.image = res.data.url
      ElMessage.success('‰∏ä‰º†ÊàêÂäü')
      opts.onSuccess?.(res)
    } else {
      throw new Error(res.message || '‰∏ä‰º†Â§±Ë¥•')
    }
  } catch (e: any) {
    ElMessage.error(e.message || '‰∏ä‰º†Â§±Ë¥•')
    opts.onError?.(e)
  }
}

function statusLabel(s?: string) {
  if (s === 'FOUND') return 'Â∑≤ÊâæÂà∞'
  if (s === 'CLOSED') return 'Â∑≤ÂÖ≥Èó≠'
  return 'ÂØªÂÆ†‰∏≠'
}

async function changeStatus(row: LostPet, s: 'ACTIVE' | 'FOUND' | 'CLOSED') {
  try {
    const res = await updateStatus(row.id!, s)
    if (res.success) {
      ElMessage.success('Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞')
      row.status = s
    }
  } catch (e: any) {
    ElMessage.error(e.message || 'Êõ¥Êñ∞Â§±Ë¥•')
  }
}

async function onDialogProvinceChange() {
  try {
    cities.value = []
    if (!dialogProvince.value) return
    const res = await listCitiesByProvince(dialogProvince.value)
    cities.value = (res as any).data || res || []
  } catch {}
}

async function loadProvinces() {
  try {
    const res = await listProvinces()
    provinces.value = (res as any).data || res || []
    
    // ÊûÑÂª∫ÁúÅÂ∏ÇÊò†Â∞Ñ
    const cityPromises = provinces.value.map(async (province) => {
      try {
        const citiesRes = await listCitiesByProvince(province)
        const citiesList = (citiesRes as any).data || citiesRes || []
        return { province, cities: citiesList }
      } catch {
        return { province, cities: [] }
      }
    })
    
    const results = await Promise.all(cityPromises)
    
    results.forEach(({ province, cities }) => {
      provinceCityMap.value[province] = cities
      cities.forEach((city: string) => {
        cityProvinceMap.value[city] = province
      })
    })
  } catch {}
}

async function inferProvinceByCity(city: string) {
  if (!city) return
  for (const p of provinces.value) {
    try {
      const res = await listCitiesByProvince(p)
      const list = (res as any).data || res || []
      if (Array.isArray(list) && list.includes(city)) {
        dialogProvince.value = p
        cities.value = list
        return
      }
    } catch {}
  }
}

function handleSizeChange(newSize: number) {
  pagination.pageSize = newSize
  pagination.currentPage = 1
  fetchData()
}

function handleCurrentChange(newPage: number) {
  pagination.currentPage = newPage
  fetchData()
}

function formatDate(dateStr: string) {
  if (!dateStr) return '-'
  return new Date(dateStr).toLocaleDateString('zh-CN')
}

onMounted(async () => {
  fetchData()
  loadProvinces()
})
</script>

<style scoped>
.lost-pets-page {
  padding: 24px;
  background: #f8f9fa;
  min-height: 100vh;
}

.page-header {
  margin-bottom: 24px;
}

.page-header h2 {
  margin: 0 0 8px 0;
  color: #1f2937;
  font-size: 28px;
  font-weight: 600;
}

.page-header p {
  margin: 0;
  color: #6b7280;
  font-size: 16px;
}

.filter-card {
  margin-bottom: 24px;
  border: none;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.filter-container {
  padding: 8px 0;
}

.stats-info {
  color: #6b7280;
  font-size: 14px;
  font-weight: 500;
}

.table-card {
  border: none;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.simple-table {
  border-radius: 8px;
  overflow: hidden;
}

.pet-info {
  display: flex;
  align-items: center;
}

.pet-details {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.pet-name {
  font-weight: 600;
  color: #1f2937;
}

.pet-type {
  font-size: 12px;
  color: #6b7280;
}

.location {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.city {
  font-size: 12px;
  color: #6b7280;
}

.reward {
  color: #dc2626;
  font-weight: 600;
}

.no-reward {
  color: #9ca3af;
}

.lost-time {
  font-size: 12px;
  color: #6b7280;
}

.pagination-wrapper {
  margin-top: 24px;
  display: flex;
  justify-content: center;
}

.dialog-form {
  padding: 0 8px;
}

.image-upload {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.image-preview {
  margin-top: 8px;
}

:deep(.el-table) {
  border: none;
}

:deep(.el-table th) {
  background: #f9fafb;
  color: #374151;
  font-weight: 600;
  border-bottom: 1px solid #e5e7eb;
}

:deep(.el-table td) {
  border-bottom: 1px solid #f3f4f6;
}

:deep(.el-table__row):hover {
  background: #f9fafb;
}

:deep(.el-card__body) {
  padding: 20px;
}

:deep(.el-empty) {
  padding: 60px 0;
}
</style>