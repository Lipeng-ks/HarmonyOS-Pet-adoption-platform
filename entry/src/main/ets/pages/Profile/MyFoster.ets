import { router } from '@kit.ArkUI';
import prompt from '@system.prompt';
import { ApiService, Animal } from '../../common/services/ApiService';
import { UserService } from '../../common/database/UserService';
import { UserInfo } from '../../common/models/UserInfo';

// é€å…»çŠ¶æ€å¸¸é‡ï¼ˆé¿å…ä½¿ç”¨ as const/typeofï¼‰
const FOSTER_LISTED: string = 'ä¸Šæ¶ä¸­'
const FOSTER_OFFLINE: string = 'å·²ä¸‹æ¶'
const FOSTER_ADOPTED: string = 'å·²é¢†å…»'

// ä¸ºäº† ArkTS å…¼å®¹ï¼Œä½¿ç”¨ç®€å•çš„ string ç±»å‹
type FosterStatusType = string

// é€å…»å‘å¸ƒæ•°æ®ç»“æ„
interface FosterPost {
  id: number;
  animal: Animal;
  status: FosterStatusType;
  views: number;
  favorites: number;
  createdAt: string;
  updatedAt?: string;
}

function nowStr(): string {
  const d = new Date();
  const p = (n: number) => String(n).padStart(2, '0');
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`
}

// æœ¬åœ°å›¾ç‰‡èµ„æºå ä½ï¼ˆæ²¿ç”¨ç°æœ‰æœ¬åœ°èµ„æºå‘½åé£æ ¼ï¼‰ï¼Œç”¨äºå…œåº•æ˜¾ç¤º
const LOCAL_MEDIA: string[] = [
  'app.media.jdfogpd',
  'app.media.lhmsdf',
  'app.media.dfghidg',
  'app.media.xjzxmm',
  'app.media.ilsdnvldfg',
  'app.media.lsdrhgd',
  'app.media.xmxmm',
  'app.media.tyikjgch',
  'app.media.ksdhf',
  'app.media.ddfchjbd'
]

@Entry
@Component
struct MyFoster {
  private tabs: string[] = ['å…¨éƒ¨', FOSTER_LISTED, FOSTER_OFFLINE, FOSTER_ADOPTED]
  @State currentTab: number = 0
  @State allPosts: FosterPost[] = []
  @State posts: FosterPost[] = []
  @State isLoading: boolean = true
  @State AnimalColor2: string = '#ffdbdbdb'
  
  private apiService: ApiService = ApiService.getInstance();
  private userService: UserService = UserService.getInstance();
  

  // ç»Ÿä¸€èƒ¶å›Šæ ‡ç­¾
  @Builder TagPill(text: string, bg: ResourceColor, color: ResourceColor): void {
    Row() {
      Text(text)
        .fontSize(12)
        .fontWeight(FontWeight.Medium)
        .fontColor(color)
    }
    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
    .backgroundColor(bg)
    .borderRadius(10)
  }

  // ç»Ÿä¸€æ“ä½œæŒ‰é’®ï¼ˆæè¾¹æˆ–æµ…åº•å¡«å……ï¼‰
  @Builder ActionBtn(label: string, textColor: ResourceColor, bgColor: ResourceColor, borderColor?: ResourceColor, onTap?: () => void): void {
    Button(label)
      .type(ButtonType.Capsule)
      .fontSize(14)
      .fontColor(textColor)
      .backgroundColor(bgColor)
      .height(34)
      .padding({ left: 16, right: 16 })
      .border({ width: 1, color: borderColor ? borderColor : bgColor })
      .shadow({ radius: 6, color: '#00000008', offsetY: 2 })
      .onClick(() => { if (onTap) { onTap() } })
  }

  async aboutToAppear(): Promise<void> {
    // ç™»å½•æ ¡éªŒ
    const isLoggedIn = AppStorage.Get('isLoggedIn') as boolean | undefined;
    if (!isLoggedIn) {
      prompt.showToast({ message: 'è¯·å…ˆç™»å½•åæŸ¥çœ‹æˆ‘çš„é€å…»', duration: 1500 });
      try { router.replaceUrl({ url: 'pages/Auth/Login' }) } catch (_) { router.pushUrl({ url: 'pages/Auth/Login' }) }
      return;
    }
    await this.loadMyFosterPosts();
    this.filterByTab(this.currentTab)
  }

  onPageShow(): void {
    // è¿”å›æ—¶åˆ·æ–°æ•°æ®
    this.loadMyFosterPosts();
  }

  // çŠ¶æ€ç­›é€‰
  filterByTab(index: number): void {
    this.currentTab = index
    const label = this.tabs[index]
    if (label === 'å…¨éƒ¨') {
      this.posts = this.allPosts
    } else if (label === FOSTER_ADOPTED) {
      // ç­›é€‰å·²é¢†å…»çš„åŠ¨ç‰©
      this.posts = this.allPosts.filter((p: FosterPost) => p.animal.adopted === true)
    } else {
      this.posts = this.allPosts.filter((p: FosterPost) => p.status === label && p.animal.adopted !== true)
    }
  }

  // ä»åç«¯åŠ è½½å½“å‰ç”¨æˆ·çš„é€å…»å‘å¸ƒï¼ˆæŒ‰ animal.userId è¿‡æ»¤ï¼‰
  async loadMyFosterPosts(): Promise<void> {
    this.isLoading = true;
    try {
      const userInfo = AppStorage.Get('userInfo') as UserInfo | undefined;
      const username = userInfo?.username;
      let userId: number | null = null;

      if (username && username.trim().length > 0) {
        try {
          await this.userService.init();
          const idStr = await this.userService.getUserIdByUsername(username);
          const parsed = idStr ? Number(idStr) : NaN;
          if (!isNaN(parsed)) userId = parsed;
        } catch (e) {
          console.warn('UserService åˆå§‹åŒ–æˆ–è·å– userId å¤±è´¥ï¼Œå›é€€ä¸ºæ˜¾ç¤ºå…¨éƒ¨åŠ¨ç‰©');
        }
      }

      const animals: Animal[] = await this.apiService.getAnimals();

      // è¿‡æ»¤å‡ºå½“å‰ç”¨æˆ·å‘å¸ƒçš„åŠ¨ç‰©ï¼ˆè‹¥æ— æ³•è¯†åˆ«ç”¨æˆ·ï¼Œåˆ™æ˜¾ç¤ºç©ºåˆ—è¡¨ï¼Œä»¥é¿å…æ˜¾ç¤ºä»–äººå‘å¸ƒï¼‰
      const mine = (userId != null)
        ? animals.filter(a => {
            try { return Number(a.userId) === userId } catch { return false }
          })
        : [];

      // å…œåº•å¤„ç†å›¾ç‰‡ï¼šå°†å‰è‹¥å¹²æ¡å¼ºåˆ¶æ›¿æ¢ä¸ºæœ¬åœ°èµ„æºï¼Œé¿å… URL åœ¨ $r æ¸²æŸ“å¤±è´¥
      for (let i = 0; i < Math.min(10, mine.length); i++) {
        try {
          const img = mine[i].image || '';
          if (!img.startsWith || !img.startsWith('app.media.')) {
            mine[i].image = LOCAL_MEDIA[i] || 'app.media.pet';
          }
        } catch (_) {
          mine[i].image = LOCAL_MEDIA[i] || 'app.media.pet';
        }
      }

      // æ˜ å°„ä¸ºé¡µé¢å±•ç¤ºæ‰€éœ€çš„ FosterPost
      this.allPosts = mine.map((a: Animal, idx: number) => {
        let status = FOSTER_LISTED;
        if (a.adopted === true) {
          status = FOSTER_ADOPTED;
        } else if (a.listed === false) {
          status = FOSTER_OFFLINE;
        }
        return {
          id: a.id,
          animal: a,
          status: status,
          views: 0,
          favorites: Number(a.favoriteCount || 0),
          createdAt: nowStr(),
          updatedAt: undefined
        } as FosterPost;
      });

      this.filterByTab(this.currentTab);
    } catch (error) {
      console.error(`åŠ è½½æˆ‘çš„é€å…»å¤±è´¥: ${error}`);
      prompt.showToast({ message: 'åŠ è½½æˆ‘çš„é€å…»å¤±è´¥', duration: 1500 });
    } finally {
      this.isLoading = false;
    }
  }

  // ä¸Šæ¶
  async listPost(id: number): Promise<void> {
    try {
      const res: Animal | null = await this.apiService.updateAnimalListed(id, true);
      if (!res) {
        prompt.showToast({ message: 'ä¸Šæ¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', duration: 1500 });
        return;
      }
      // åŒæ­¥æ›´æ–°æœ¬åœ°åˆ—è¡¨
      this.allPosts = this.allPosts.map((p: FosterPost) => {
        if (p.id === id) {
          const updatedAnimal: Animal = {
            id: p.animal.id,
            name: p.animal.name,
            gender: p.animal.gender,
            age: p.animal.age,
            type: p.animal.type,
            description: p.animal.description,
            vaccinated: p.animal.vaccinated,
            dewormed: p.animal.dewormed,
            neutered: p.animal.neutered,
            image: p.animal.image,
            city: p.animal.city,
            isFree: p.animal.isFree,
            favoriteCount: p.animal.favoriteCount,
            userId: p.animal.userId,
            adopted: p.animal.adopted,
            listed: true
          } as Animal;
          const updatedPost: FosterPost = {
            id: p.id,
            animal: updatedAnimal,
            status: FOSTER_LISTED,
            views: p.views,
            favorites: p.favorites,
            createdAt: p.createdAt,
            updatedAt: nowStr()
          } as FosterPost;
          return updatedPost;
        }
        return p;
      });
      this.filterByTab(this.currentTab);
      // å¼ºåˆ¶è§¦å‘æ¸²æŸ“
      this.posts = [...this.posts];
      prompt.showToast({ message: 'å·²ä¸Šæ¶', duration: 1200 });
    } catch (e) {
      console.error('listPost error:', e);
      prompt.showToast({ message: 'ä¸Šæ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', duration: 1500 });
    }
  }

  // ä¸‹æ¶
  async offlinePost(id: number): Promise<void> {
    try {
      const res: Animal | null = await this.apiService.updateAnimalListed(id, false);
      if (!res) {
        prompt.showToast({ message: 'ä¸‹æ¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', duration: 1500 });
        return;
      }
      // åŒæ­¥æ›´æ–°æœ¬åœ°åˆ—è¡¨
      this.allPosts = this.allPosts.map((p: FosterPost) => {
        if (p.id === id) {
          const updatedAnimal: Animal = {
            id: p.animal.id,
            name: p.animal.name,
            gender: p.animal.gender,
            age: p.animal.age,
            type: p.animal.type,
            description: p.animal.description,
            vaccinated: p.animal.vaccinated,
            dewormed: p.animal.dewormed,
            neutered: p.animal.neutered,
            image: p.animal.image,
            city: p.animal.city,
            isFree: p.animal.isFree,
            favoriteCount: p.animal.favoriteCount,
            userId: p.animal.userId,
            adopted: p.animal.adopted,
            listed: false
          } as Animal;
          const updatedPost: FosterPost = {
            id: p.id,
            animal: updatedAnimal,
            status: FOSTER_OFFLINE,
            views: p.views,
            favorites: p.favorites,
            createdAt: p.createdAt,
            updatedAt: nowStr()
          } as FosterPost;
          return updatedPost;
        }
        return p;
      });
      this.filterByTab(this.currentTab);
      // å¼ºåˆ¶è§¦å‘æ¸²æŸ“
      this.posts = [...this.posts];
      prompt.showToast({ message: 'å·²ä¸‹æ¶', duration: 1200 });
    } catch (e) {
      console.error('offlinePost error:', e);
      prompt.showToast({ message: 'ä¸‹æ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', duration: 1500 });
    }
  }

  // ç¼–è¾‘å® ç‰©ä¿¡æ¯
  editPost(id: number): void {
    try {
      router.pushUrl({ 
        url: 'pages/Profile/EditRehomePet',
        params: { 
          id: id,
          mode: 'edit'
        }
      })
    } catch (error) {
      console.error('è·³è½¬ç¼–è¾‘é¡µé¢å¤±è´¥:', error)
      prompt.showToast({ message: 'è·³è½¬å¤±è´¥ï¼Œè¯·é‡è¯•', duration: 1500 })
    }
  }

  

  

  // é¡¶éƒ¨æ 
  @Builder TopBar(): void {
    Stack() {
      // èƒŒæ™¯è¡Œå¸ƒå±€ï¼Œç”¨äºå·¦å³æŒ‰é’®å®šä½
      Row() {
        // å·¦ä¾§è¿”å›æŒ‰é’®
        Button() {
          Image($r('app.media.arrow_left'))
            .width(24)
            .height(24)
            .fillColor('#1C1C1E')
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .width(44)
        .height(44)
        .borderRadius(22)
        .onClick(() => router.back())

        Blank()

        // å³ä¾§å‘å¸ƒæŒ‰é’®
        Button('å‘å¸ƒ')
          .type(ButtonType.Normal)
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor('#FF6B35')
          .borderRadius(22)
          .padding({ left: 20, right: 20, top: 10, bottom: 10 })
          .onClick(() => {
            router.pushUrl({
              url: 'pages/Profile/EditRehomePet',
              params: { mode: 'create' }
            }).catch((error: Error) => {
              console.error('è·³è½¬å¤±è´¥:', error);
              prompt.showToast({ message: 'è·³è½¬å¤±è´¥ï¼Œè¯·é‡è¯•', duration: 1500 });
            });
          })
      }
      .width('100%')
      .height('100%')
      .padding({ left: 16, right: 16 })

      // ç»å¯¹å±…ä¸­çš„æ ‡é¢˜
      Text('æˆ‘çš„é€å…»')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1C1C1E')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height(56)
    .backgroundColor(Color.White)
    .border({ width: { bottom: 0.5 }, color: '#E5E5EA' })
    .alignContent(Alignment.Center)
  }

  // ç­›é€‰ Tabs
  @Builder TabsBar(): void {
    Tabs() {
      TabContent() { this.ListBuilder() }.tabBar('å…¨éƒ¨')
      TabContent() { this.ListBuilder() }.tabBar('ä¸Šæ¶ä¸­')
      TabContent() { this.ListBuilder() }.tabBar('å·²ä¸‹æ¶')
      TabContent() { this.ListBuilder() }.tabBar('å·²é¢†å…»')
    }
    .onChange((i: number) => this.filterByTab(i))
    .barMode(BarMode.Fixed)
    .barHeight(36)
    .width('100%')
    .layoutWeight(1)
  }

  // åˆ—è¡¨é¡¹å¡ç‰‡
  @Builder FosterCard(item: FosterPost): void {
    Column() {
      Row() {
        Row() {
          Text(`æ”¶è— ${item.favorites}`)
            .fontSize(12)
            .fontColor('#8E8E93')
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.End)

      // å†…å®¹è¡Œ
      Row() {
        Image($r(item.animal.image || 'app.media.pet'))
          .width(92)
          .height(92)
          .borderRadius(18)
          .objectFit(ImageFit.Cover)
          .backgroundColor('#F2F2F7')
          .border({ width: 1, color: '#ECECED' })

        Column() {
          Row() {
            Text(item.animal.name)
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1C1C1E')
          }
          .margin({ bottom: 6 })

          Row() {
            Text(`${item.animal.age}å²`)
              .fontSize(14)
              .fontColor('#8E8E93')
            Text('Â·').fontSize(14).fontColor('#8E8E93').margin({ left: 4, right: 4 })
            Text(item.animal.gender ? 'é›„æ€§' : 'é›Œæ€§')
              .fontSize(14)
              .fontColor('#8E8E93')
          }
          .margin({ bottom: 6 })

          Row() {
            Text(item.animal.city)
              .fontSize(13)
              .fontColor('#8E8E93')
          }

          // å¥åº·æ ‡ç­¾ï¼ˆç»Ÿä¸€èƒ¶å›Šæ ·å¼ï¼‰
          Row() {
            Row() {
              Text(item.animal.neutered ? 'å·²ç»è‚²' : 'æœªç»è‚²')
                .fontSize(12)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
            }
            .borderRadius(5)
            .padding(5)
            .backgroundColor(item.animal.neutered ? Color.Orange : this.AnimalColor2)
            Row() {
              Text(item.animal.vaccinated ? 'å·²å…ç–«' : 'æœªå…ç–«')
                .fontSize(12)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
            }
            .margin({ left: 5 })
            .borderRadius(5)
            .padding(5)
            .backgroundColor(item.animal.vaccinated ? Color.Orange : this.AnimalColor2)
            Row() {
              Text(item.animal.dewormed ? 'å·²é©±è™«' : 'æœªé©±è™«')
                .fontSize(12)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
            }
            .margin({ left: 5 })
            .borderRadius(5)
            .padding(5)
            .backgroundColor(item.animal.dewormed ? Color.Orange : this.AnimalColor2)

          }
          .margin({ top: 6 })
        }
        .layoutWeight(1)
        .margin({ left: 14 })
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
      .margin({ top: 10, bottom: 8 })

      // åˆ†å‰²çº¿
      Row()
        .width('100%')
        .height(0.5)
        .backgroundColor('#EFEFF4')
        .margin({ bottom: 12 })

      // æ“ä½œåŒºï¼ˆå·¦ï¼šè¯¦æƒ…é“¾æ¥ï¼›å³ï¼šç¼–è¾‘ + çŠ¶æ€æŒ‰é’®ï¼‰
      Row() {
        // å·¦ä¾§ï¼šè¯¦æƒ…é“¾æ¥å¼æŒ‰é’®ï¼ˆç»Ÿä¸€ä¸»é¢˜è‰²ï¼‰
        this.ActionBtn('è¯¦æƒ…é¡µé¢', '#0A84FF', '#0A84FF15', '#BBD9FF', () => {
          router.pushUrl({ url: 'pages/Home/AnimalDetail', params: { id: item.animal?.id ?? item.id } })
        })

        // å³ä¾§ï¼šæŒ‰é’®ç»„ï¼ˆå›ºå®šåœ¨å³ä¸‹è§’ï¼‰
        Row() {
          // å·²è¢«é¢†å…»åˆ™ä¸æ˜¾ç¤ºç¼–è¾‘ä¸ä¸Š/ä¸‹æ¶æŒ‰é’®
          if (!item.animal.adopted) {
            // ç¼–è¾‘ï¼ˆç»Ÿä¸€ä¸»é¢˜è‰²ï¼‰
            this.ActionBtn('ç¼–è¾‘', '#0A84FF', '#0A84FF15', '#BBD9FF', () => this.editPost(item.id))
            // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸Š/ä¸‹æ¶ï¼ˆç»Ÿä¸€ä¸»é¢˜è‰²ï¼‰
            if (item.status === FOSTER_LISTED) {
              this.ActionBtn('ä¸‹æ¶', '#0A84FF', '#0A84FF15', '#BBD9FF', () => this.offlinePost(item.id))
            } else if (item.status === FOSTER_OFFLINE) {
              this.ActionBtn('ä¸Šæ¶', '#0A84FF', '#0A84FF15', '#BBD9FF', () => this.listPost(item.id))
            }
          } else {
            // å³ä¸‹è§’æ˜¾ç¤ºâ€œå·²è¢«é¢†å…»â€å¾½æ ‡ï¼ˆèƒ¶å›Šæ ‡ç­¾æ ·å¼ï¼‰
            this.TagPill('å·²è¢«é¢†å…»', '#FFEDE5', '#FF3B30')
          }
        }
        .justifyContent(FlexAlign.End)
        .alignItems(VerticalAlign.Bottom)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(18)
    .padding(16)
    .margin({ bottom: 16 })
    .shadow({ radius: 10, color: '#00000010', offsetY: 6 })
  }

  // åˆ—è¡¨
  @Builder ListBuilder(): void {
    List() {
      // æ•°æ®é¡¹
      if (this.isLoading) {
        ListItem() {
          Row() {
            LoadingProgress().width(40).height(40)
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
        }
      } else {
        ForEach(this.posts, (item: FosterPost) => {
          ListItem() { this.FosterCard(item) }
        }, (item: FosterPost) => `${item.id}-${item.status}`)
      }

      // ç©ºçŠ¶æ€
      if (!this.isLoading && this.posts.length === 0) {
        ListItem() {
          Column() {
            Text(this.currentTab === 3 ? 'ğŸ‰' : 'ğŸ“¦')
              .fontSize(60)
              .margin({ top: 60 })
            Text(this.currentTab === 3 ? 'æš‚æ— å·²é¢†å…»çš„å® ç‰©' : 'æš‚æ— é€å…»å‘å¸ƒ')
              .fontSize(18)
              .fontColor('#8E8E93')
              .fontWeight(FontWeight.Medium)
              .margin({ top: 20 })
            Text(this.currentTab === 3 ? 'æ‚¨å‘å¸ƒçš„å® ç‰©è¿˜æœªè¢«é¢†å…»' : 'ç‚¹å‡»ä¸Šæ–¹ä¸åŒçŠ¶æ€æ ‡ç­¾æŸ¥çœ‹')
              .fontSize(14)
              .fontColor('#C7C7CC')
              .textAlign(TextAlign.Center)
              .lineHeight(20)
              .margin({ top: 8 })
          }
          .width('100%')
          .height(400)
          .justifyContent(FlexAlign.Center)
        }
      }
    }
    .edgeEffect(EdgeEffect.Spring)
    .width('100%')
    .height('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    .scrollBar(BarState.Off)
  }

  build() {
    Column() {
      this.TopBar()
      this.TabsBar()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F2F7')
  }
}
