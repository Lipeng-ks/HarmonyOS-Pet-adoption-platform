import { router } from '@kit.ArkUI';
import { Animal, ApiService, AdoptionOrder } from '../../common/services/ApiService';
import { AdoptionRecord } from '../../common/models/AdoptionRecord';
import prompt from '@system.prompt';
import { UserService } from '../../common/database/UserService';
import { UserInfo } from '../../common/models/UserInfo';

@Entry
@Component
struct Adopt {
  @State AnimalColor2: string = '#ffdbdbdb'
  @State adoptionRecords: AdoptionRecord[] = [];
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  private apiService = ApiService.getInstance();
  private userService?: UserService;

  async onPageShow() {
    console.info('[Adopt] onPageShow - é¡µé¢æ˜¾ç¤º');
    await this.loadCompletedOrders();
  }

  // åŠ è½½å·²å®Œæˆçš„è®¢å•æ•°æ®
  async loadCompletedOrders() {
    console.info('[Adopt] loadCompletedOrders - å¼€å§‹åŠ è½½å·²å®Œæˆè®¢å•');
    
    try {
      this.isLoading = true;
      this.errorMessage = '';
      
      // è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆä¼˜å…ˆä» AppStorage ä¸­è¯»å–å®Œæ•´ userInfoï¼‰
      const storedUser = AppStorage.Get<UserInfo>('userInfo') as UserInfo | undefined;
      const username = (storedUser && storedUser.username) || AppStorage.Get<string>('currentUsername');
      console.info(`[Adopt] loadCompletedOrders - å½“å‰ç”¨æˆ·: ${username}`);
      
      let orders: AdoptionOrder[] = [];
      
      if (username && username.trim().length > 0) {
        // ç¡®ä¿ UserService åˆå§‹åŒ–
        try {
          if (!this.userService) {
            this.userService = UserService.getInstance();
          }
          await this.userService.init();
        } catch (e) {
          console.warn(`UserService åˆå§‹åŒ–å¤±è´¥ï¼Œå›é€€å…¨é‡è®¢å•: ${e}`);
        }

        try {
          if (this.userService) {
            const userIdStr = await this.userService.getUserIdByUsername(username);
            const userId = userIdStr ? Number(userIdStr) : NaN;
            if (!isNaN(userId)) {
              // è·å–è¯¥ç”¨æˆ·çš„æ‰€æœ‰è®¢å•ï¼ˆåç«¯æŒ‰ç”¨æˆ·æŸ¥è¯¢ï¼‰
              const allUserOrders = await this.apiService.getAdoptionOrdersByUser(userId);
              orders = allUserOrders.filter(order => order.status === 'å®Œæˆ');
              console.info(`[Adopt] loadCompletedOrders - ç”¨æˆ·${userId}æœ‰${allUserOrders.length}ä¸ªè®¢å•ï¼Œå…¶ä¸­${orders.length}ä¸ªå·²å®Œæˆ`);
            } else {
              console.warn('æœªèƒ½è§£æç”¨æˆ·IDï¼Œä½¿ç”¨åç«¯æŒ‰çŠ¶æ€æŸ¥è¯¢å·²å®Œæˆè®¢å•');
              // ç›´æ¥æŒ‰çŠ¶æ€ä»åç«¯æŸ¥è¯¢ï¼Œé¿å…æ‹‰å–å…¨é‡æ•°æ®å†è¿‡æ»¤
              orders = await this.apiService.getAdoptionOrdersByStatus('å®Œæˆ');
            }
          } else {
            console.warn('UserService æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨åç«¯æŒ‰çŠ¶æ€æŸ¥è¯¢å·²å®Œæˆè®¢å•');
            orders = await this.apiService.getAdoptionOrdersByStatus('å®Œæˆ');
          }
        } catch (e) {
          console.warn(`æŒ‰ç”¨æˆ·æŸ¥è¯¢è®¢å•å¤±è´¥ï¼Œå›é€€å…¨é‡è®¢å•: ${e}`);
          const allOrders = await this.apiService.getAllAdoptionOrders();
          orders = allOrders.filter(order => order.status === 'å®Œæˆ');
        }
      } else {
        console.warn('æœªæ‰¾åˆ°å·²ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨åç«¯æŒ‰çŠ¶æ€æŸ¥è¯¢å·²å®Œæˆè®¢å•');
        orders = await this.apiService.getAdoptionOrdersByStatus('å®Œæˆ');
      }
      
      console.info(`[Adopt] loadCompletedOrders - æœ€ç»ˆè·å–åˆ° ${orders.length} ä¸ªå·²å®Œæˆè®¢å•`);

      // è½¬æ¢ä¸ºAdoptionRecordæ ¼å¼ï¼šè®¢å•æ•°æ®ä¿æŒä¸º AdoptionOrderï¼Œå±•ç¤ºæ•°æ®ç»Ÿä¸€å°è£…ä¸º AdoptionRecord
      this.adoptionRecords = orders.map(order => this.convertOrderToRecord(order));

      // è¡¥å…¨åŠ¨ç‰©è¯¦æƒ…ï¼šè‹¥ adoption record ä¸­ animal.id å¯ç”¨ï¼Œè°ƒç”¨åç«¯è·å–å®Œæ•´ animal å¯¹è±¡
      const localResources = [
        'app.media.jdfogpd',
        'app.media.lhmsdf',
        'app.media.dfghidg',
        'app.media.xjzxmm',
        'app.media.ilsdnvldfg',
        'app.media.lsdrhgd',
        'app.media.xmxmm',
        'app.media.tyikjgch',
        'app.media.ksdhf',
        'app.media.ddfchjbd'
      ];

      // å…ˆå°è¯•æ‹‰å–æ‰€æœ‰åŠ¨ç‰©ä½œä¸ºå›é€€åŒ¹é…æºï¼ˆé¿å…å¯¹æ¯æ¡è®°å½•é‡å¤è¯·æ±‚ï¼‰
      let allAnimalsCache: Animal[] = [];
      try {
        allAnimalsCache = await this.apiService.getAnimals();
      } catch (e) {
        console.warn('[Adopt] è·å–å…¨éƒ¨åŠ¨ç‰©ä½œä¸ºåŒ¹é…æºå¤±è´¥', e);
      }

      await Promise.all(this.adoptionRecords.map(async (rec, idx) => {
        try {
          const animalId = rec.animal && rec.animal.id ? rec.animal.id : undefined;
          if (typeof animalId === 'number' && animalId > 0) {
            const full = await this.apiService.getAnimalById(animalId);
            if (full) {
              rec.animal = full;
            }
          } else if (rec.animal && rec.animal.name) {
            // å›é€€åŒ¹é…ï¼šæŒ‰åç§°ï¼ˆå¿½ç•¥å¤§å°å†™/ç©ºç™½ï¼‰å’ŒåŸå¸‚å°è¯•åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾
            const norm = (s: string) => (s || '').toString().trim().toLowerCase();
            const targetName = norm(rec.animal.name);
            const targetCity = norm(rec.animal.city || '');
            const matched = allAnimalsCache.find(a => {
              const an = norm(a.name);
              const ac = norm(a.city || '');
              if (an !== targetName) return false;
              if (targetCity && ac !== targetCity) return false;
              return true;
            });
            if (matched) {
              rec.animal = matched;
            }
          }

          // å›¾ç‰‡å›é€€ï¼šç¡®ä¿å±•ç¤ºä½¿ç”¨æœ¬åœ° app.media èµ„æºï¼Œé¿å…è¿œç¨‹ä¸ºç©º
          const img = rec.animal && rec.animal.image ? rec.animal.image : '';
          if (!img || typeof img !== 'string' || !img.startsWith || !img.startsWith('app.media.')) {
            rec.animal.image = localResources[idx % localResources.length] || 'app.media.pet';
          }
        } catch (e) {
          console.warn('[Adopt] è¡¥å…¨åŠ¨ç‰©è¯¦æƒ…å¤±è´¥', e);
        }
      }));
      
    } catch (error) {
      console.error('[Adopt] loadCompletedOrders - åŠ è½½å¤±è´¥:', JSON.stringify(error));
      this.errorMessage = 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•';
      this.adoptionRecords = [];
    } finally {
      this.isLoading = false;
    }
  }

  // å°†åç«¯è®¢å•æ•°æ®è½¬æ¢ä¸ºå‰ç«¯æ˜¾ç¤ºæ ¼å¼
  convertOrderToRecord(order: AdoptionOrder): AdoptionRecord {
    // ç¡®ä¿ order å¯¹è±¡å­˜åœ¨
    if (!order) {
      console.warn('[Adopt] convertOrderToRecord - è®¢å•å¯¹è±¡ä¸ºç©º');
      return this.createEmptyRecord();
    }

    console.info(`[Adopt] convertOrderToRecord - è½¬æ¢è®¢å• ID: ${order.id}, ç”³è¯·ç†ç”±: ${order.applicationReason || 'æ— '}`);

    // æ„å»º AdoptionRecordï¼šä¿è¯ animal å­—æ®µæ€»æ˜¯å­˜åœ¨ï¼ˆä¼˜å…ˆä½¿ç”¨ order.animalï¼Œè‹¥æ— åˆ™æ„é€ æœ€å°å ä½ï¼‰
    const animalData: Animal = order.animal ? order.animal as Animal : {
      id: 0,
      name: order.petName || 'æœªçŸ¥å® ç‰©',
      gender: true,
      age: 0,
      type: 'å® ç‰©',
      description: order.applicationReason || '',
      vaccinated: false,
      dewormed: false,
      neutered: false,
      image: order.image || 'app.media.pet',
      city: order.petAddress || '',
      isFree: true
    };

    return {
      id: order.id || 0,
      orderNo: order.orderNo,
      userId: order.userId,
      animal: animalData,
      shippingAddress: order.shippingAddress,
      petExperience: order.petExperience,
      applicationReason: order.applicationReason,
      status: order.status || 'å®¡æ ¸ä¸­',
      applicationTime: order.applicationTime || '',
      createdAt: order.createdAt,
      updatedAt: order.updatedAt,
      completedAt: order.completedAt,
      contactInfo: order.shippingAddress || '',
      adoptionFee: order.adoptionFee || 0,
      urgencyLevel: order.urgencyLevel || 'low'
    };
  }

  // åˆ›å»ºç©ºè®°å½•
  createEmptyRecord(): AdoptionRecord {
    return {
      id: 0,
      orderNo: undefined,
      userId: undefined,
      animal: {
        id: 0,
        name: 'æœªçŸ¥å® ç‰©',
        gender: true,
        age: 0,
        type: 'å® ç‰©',
        description: 'å¯çˆ±çš„å® ç‰©',
        vaccinated: false,
        dewormed: false,
        neutered: false,
        image: 'app.media.pet',
        city: 'æœªçŸ¥åœ°å€',
        isFree: true
      },
      shippingAddress: undefined,
      petExperience: undefined,
      applicationReason: undefined,
      status: 'å®¡æ ¸ä¸­',
      applicationTime: '',
      createdAt: undefined,
      updatedAt: undefined,
      completedAt: undefined,
      contactInfo: undefined,
      adoptionFee: 0,
      urgencyLevel: 'low'
    };
  }

  // è·å–çŠ¶æ€é¢œè‰²
  getStatusColor(status: string): string {
    // ä»…å¯¹â€œå®Œæˆâ€çŠ¶æ€è¿”å›é«˜äº®é¢œè‰²ï¼Œå…¶ä½™ç»Ÿä¸€ç°è‰²
    return status === 'å®Œæˆ' ? '#5AC8FA' : '#8E8E93';
  }
  
  // è·å–ç´§æ€¥ç¨‹åº¦é¢œè‰²
  getUrgencyColor(urgencyLevel?: string): string {
    switch (urgencyLevel) {
      case 'high':
        return '#FF3B30'; // çº¢è‰²
      case 'medium':
        return '#FF9500'; // æ©™è‰²
      case 'low':
        return '#34C759'; // ç»¿è‰²
      default:
        return '#8E8E93'; // ç°è‰²
    }
  }

  // é¢†å…»è®°å½•å¡ç‰‡ç»„ä»¶
  @Builder
  AdoptionRecordCard(record: AdoptionRecord) {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ¡
      Row() {
        // ç¼–å·æ˜¾ç¤ºï¼ˆæ‰€æœ‰çŠ¶æ€éƒ½æ˜¾ç¤ºï¼‰
        Text(`ç¼–å·: ${String(record.id).padStart(6, '0')}`)
          .fontSize(12)
          .fontColor('#8E8E93')
          .backgroundColor('#F2F2F7')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(8)
        
        // ç´§æ€¥ç¨‹åº¦æ ‡è¯†
        if (record.urgencyLevel && record.status === 'å®¡æ ¸ä¸­') {
          Row() {
            Circle({ width: 6, height: 6 })
              .fill(this.getUrgencyColor(record.urgencyLevel))
            Text(record.urgencyLevel === 'high' ? 'ç´§æ€¥' : record.urgencyLevel === 'medium' ? 'ä¸€èˆ¬' : 'æ™®é€š')
              .fontSize(11)
              .fontColor(this.getUrgencyColor(record.urgencyLevel))
              .margin({ left: 4 })
          }
          .margin({ left: 8 })
        }
        
        Blank()
        if (record.status === 'å®Œæˆ') {
          Button('è¯¦æƒ…')
            .fontSize(12)
            .fontWeight(FontWeight.Medium)
            .backgroundColor('#E6F0FF')
            .fontColor('#007AFF')
            .border({ width: 1, color: '#B3D7FF' })
            .height(28)
            .padding({ left: 12, right: 12, top: 0, bottom: 0 })
            .borderRadius(14)
            .margin({ right: 8 })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/Home/AdoptApplicationDetail',
                params: { orderId: record.id }
              });
            })
        }

        // çŠ¶æ€æ ‡ç­¾
        Text(record.status)
          .fontSize(12)
          .fontColor(Color.White)
          .backgroundColor(this.getStatusColor(record.status))
          .padding({ left: 10, right: 10, top: 5, bottom: 5 })
          .borderRadius(12)
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // åŠ¨ç‰©ä¿¡æ¯è¡Œ
      Row() {
        // åŠ¨ç‰©å›¾ç‰‡ï¼ˆä½¿ç”¨ order.animal.imageï¼Œå¦‚æ— åˆ™ä½¿ç”¨å ä½å›¾ï¼‰
        Image($r(record.animal.image || 'app.media.pet'))
          .width(88)
          .height(88)
          .borderRadius(16)
          .objectFit(ImageFit.Cover)
          .backgroundColor('#F2F2F7')
          .border({ width: 1, color: '#E5E5EA' })
        
        // åŠ¨ç‰©è¯¦æƒ…
        Column() {
          Row() {
            Text(record.animal.name)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1C1C1E')
          }
          .width('100%')
          .margin({ bottom: 8 })
          
          Row() {
            Text(record.animal && typeof record.animal.age !== 'undefined' ? `${record.animal.age}å²` : '')
              .fontSize(14)
              .fontColor('#8E8E93')
            Text('Â·')
              .fontSize(14)
              .fontColor('#8E8E93')
              .margin({ left: 4, right: 4 })
            Text(typeof record.animal.gender === 'boolean' ? (record.animal.gender ? 'é›„æ€§' : 'é›Œæ€§') : '')
              .fontSize(14)
              .fontColor('#8E8E93')
          }
          .margin({ bottom: 6 })
          
          Row() {
            Text(record.animal.city || '')
              .fontSize(13)
              .fontColor('#8E8E93')
              .margin({ left: 4 })
          }
          .margin({ bottom: 8 })
          
          // å¥åº·çŠ¶æ€æ ‡ç­¾
          Row() {
            Row() {
              Text(record.animal?.neutered ? 'å·²ç»è‚²' : 'æœªç»è‚²')
                .fontSize(12)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
            }
            .borderRadius(5)
            .padding(5)
            .backgroundColor(record.animal?.neutered ? Color.Orange : this.AnimalColor2)
            Row() {
              Text(record.animal?.vaccinated ? 'å·²å…ç–«' : 'æœªå…ç–«')
                .fontSize(12)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
            }
            .margin({ left: 5 })
            .borderRadius(5)
            .padding(5)
            .backgroundColor(record.animal?.vaccinated ? Color.Orange : this.AnimalColor2)
            Row() {
              Text(record.animal?.dewormed ? 'å·²é©±è™«' : 'æœªé©±è™«')
                .fontSize(12)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
            }
            .margin({ left: 5 })
            .borderRadius(5)
            .padding(5)
            .backgroundColor(record.animal?.dewormed ? Color.Orange : this.AnimalColor2)
          }
        }
        .layoutWeight(1)
        .margin({ left: 16 })
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
      
      // åˆ†å‰²çº¿
      Divider()
        .margin({ top: 8, bottom: 8 })
        .color('#E5E5EA')
      
      // æ—¶é—´ä¿¡æ¯
      Column() {
        Row() {
          Text(`ç”³è¯·æ—¶é—´ï¼š${this.formatTime(record.applicationTime)}`)
            .fontSize(12)
            .fontColor('#8E8E93')
            .margin({ left: 4 })
        }
        .margin({ bottom: 4 })
        
        if (record.completedAt) {
          Row() {
            Text(`å®Œæˆæ—¶é—´ï¼š${this.formatTime(record.completedAt)}`)
              .fontSize(12)
              .fontColor('#8E8E93')
              .margin({ left: 4 })
          }
        }
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      .margin({ bottom: 12 })
      
      // ç”³è¯·åŸå› 
      Column() {
        Text('ç”³è¯·åŸå› ')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1C1C1E')
          .margin({ bottom: 6 })
        
        Text(record.applicationReason)
          .fontSize(13)
          .fontColor('#3C3C43')
          .lineHeight(18)
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom:10 })

        Column(){}.width("100%").height("1").backgroundColor(Color.Black).opacity(0.3).margin({ bottom:10 }) 

        Text('æ”¶è´§åœ°å€')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1C1C1E')
          .margin({ bottom: 6 })

        Text(record.shippingAddress)
          .fontSize(13)
          .fontColor('#3C3C43')
          .lineHeight(18)
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      
      // è”ç³»ä¿¡æ¯
      if (record.contactInfo && record.status === 'å·²å‘è´§') {
        Column() {
          Text('è”ç³»ä¿¡æ¯')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1C1C1E')
            .margin({ bottom: 6, top: 12 })
          
          Text(record.contactInfo)
            .fontSize(13)
            .fontColor('#007AFF')
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
      }
      
      // é¢†å…»è´¹ç”¨
      if (record.adoptionFee !== undefined && record.adoptionFee > 0) {
        Row() {
          Text('é¢†å…»è´¹ç”¨ï¼š')
            .fontSize(13)
            .fontColor('#8E8E93')
          Text(`ï¿¥${record.adoptionFee}`)
            .fontSize(14)
            .fontColor('#FF9500')
            .fontWeight(FontWeight.Medium)
        }
        .margin({ top: 8 })
      }
      
      // æ“ä½œæŒ‰é’®ï¼ˆåªæœ‰å·²å®ŒæˆçŠ¶æ€æ‰æ˜¾ç¤ºï¼‰
      if (record.status === 'å®Œæˆ') {
        Button('è”ç³»ç®¡ç†å‘˜')
          .fontSize(14)
          .fontColor('#007AFF')
          .backgroundColor('#007AFF15')
          .borderRadius(20)
          .height(40)
          .width('100%')
          .margin({ top: 16 })
          .onClick(() => {
            prompt.showToast({ message: `è”ç³» ${record.contactInfo || 'ç®¡ç†å‘˜'}ï¼Œå’¨è¯¢é¢†å…»åç»­äº‹å®œ`, duration: 2000 });
          })
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(18)
    .padding(20)
    .margin({ bottom: 16 })
    .shadow({ radius: 8, color: '#00000008', offsetY: 4 })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Image($r('app.media.arrow_left'))
            .width(24)
            .height(24)
            .fillColor('#1C1C1E')
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back();
        })
        
        Text('æˆ‘çš„é¢†å…»')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1C1C1E')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Row()
          .width(24)
          .height(24)
      }
      .width('100%')
      .height(56)
      .backgroundColor(Color.White)
      .padding({ left: 16, right: 16 })
      .border({ width: { bottom: 0.5 }, color: '#E5E5EA' })
      
      // å†…å®¹åŒºåŸŸ
      this.ContentBuilder()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F2F7')
  }

  // è·å–å·²å®Œæˆçš„é¢†å…»è®°å½•
  getCompletedRecords(): AdoptionRecord[] {
    return this.adoptionRecords.filter(record => record.status === 'å®Œæˆ');
  }
  
  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  formatTime(timeStr: string): string {
    if (!timeStr) return 'æš‚æ— ';
    
    try {
      // å¤„ç†æ ‡å‡†æ ¼å¼ï¼š"2024-08-24 14:30:00" æˆ– "2024-08-24T14:30:00"
      if (timeStr.includes('-') && (timeStr.includes(' ') || timeStr.includes('T'))) {
        const standardTime = timeStr.replace('T', ' ').substring(0, 19);
        return standardTime;
      }
      
      // å¤„ç†ISOæ ¼å¼
      const date = new Date(timeStr);
      if (!isNaN(date.getTime())) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
      }
      
      return timeStr;
    } catch (error) {
      console.error('[Adopt] formatTime - æ—¶é—´æ ¼å¼åŒ–å¤±è´¥:', error);
      return timeStr;
    }
  }

  // å†…å®¹æ„å»ºå™¨
  @Builder
  ContentBuilder() {
    if (this.isLoading) {
      // åŠ è½½çŠ¶æ€
      Column() {
        LoadingProgress()
          .width(40)
          .height(40)
          .color('#007AFF')
        
        Text('åŠ è½½ä¸­...')
          .fontSize(14)
          .fontColor('#8E8E93')
          .margin({ top: 12 })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
    } else if (this.errorMessage) {
      // é”™è¯¯çŠ¶æ€
      Column() {
        Text('ğŸ˜•')
          .fontSize(60)
          .margin({ top: 60 })
        
        Text(this.errorMessage)
          .fontSize(16)
          .fontColor('#FF3B30')
          .fontWeight(FontWeight.Medium)
          .margin({ top: 20 })
        
        Button('é‡æ–°åŠ è½½')
          .fontSize(15)
          .fontColor('#007AFF')
          .backgroundColor('#007AFF15')
          .borderRadius(24)
          .height(48)
          .width(160)
          .margin({ top: 32 })
          .onClick(() => {
            this.loadCompletedOrders();
          })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
    } else {
      List() {
        ForEach(
          this.getCompletedRecords(),
          (record: AdoptionRecord) => {
            ListItem() {
              this.AdoptionRecordCard(record)
            }
          },
          (record: AdoptionRecord) => `${record.id}`
        )
        
        // ç©ºçŠ¶æ€
        if (this.getCompletedRecords().length === 0) {
          ListItem() {
            Column() {
              Text('ğŸ†')
                .fontSize(60)
                .margin({ top: 60 })
              
              Text('æš‚æ— å·²å®Œæˆçš„é¢†å…»è®°å½•')
                .fontSize(18)
                .fontColor('#8E8E93')
                .fontWeight(FontWeight.Medium)
                .margin({ top: 20 })
              
              Text('å®Œæˆé¢†å…»åçš„è®°å½•ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ\næ„Ÿè°¢æ‚¨ä¸ºå°åŠ¨ç‰©ä»¬æä¾›æ¸©æš–çš„å®¶')
                .fontSize(14)
                .fontColor('#C7C7CC')
                .textAlign(TextAlign.Center)
                .lineHeight(20)
                .margin({ top: 12 })
              
              Button('å»é¦–é¡µçœ‹çœ‹')
                .fontSize(15)
                .fontColor('#007AFF')
                .backgroundColor('#007AFF15')
                .borderRadius(24)
                .height(48)
                .width(160)
                .margin({ top: 32 })
                .onClick(() => {
                  router.pushUrl({ url: 'pages/Home/Home' });
                })
            }
            .width('100%')
            .height(500)
            .justifyContent(FlexAlign.Center)
          }
        }
      }
      .width('100%')
      .height('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 16 })
      .scrollBar(BarState.Off)
    }
  }
}